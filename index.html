<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RGEN CSV í•„í„°ë§ (Mismatches 0/1/2 = 1/0/0 & Direction='-')</title>

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSV íŒŒì„œ: Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- ì—‘ì…€ ìƒì„±: SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { font-size: 24px; margin-bottom: 20px; }
    .container { max-width: 1000px; }
    .table-container { margin-top: 20px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>RGEN CSV í•„í„°ë§ (Mismatches 0/1/2 = 1/0/0 & Direction='-')</h1>

    <!-- íŒŒì¼ ì„ íƒ ì„¹ì…˜ -->
    <div class="mb-4">
      <input type="file" id="fileInput" class="form-control">
    </div>

    <div id="status" class="mb-3 text-muted"></div>
    <div id="columnsList" class="mb-4 text-muted"></div>

    <!-- í•„í„° ë²„íŠ¼ ì„¹ì…˜ -->
    <button id="filterBtn" class="btn btn-primary" style="display:none;">ì´ ê¸°ì¤€ìœ¼ë¡œ í•„í„°í•˜ê¸°</button>

    <!-- ê²°ê³¼ ì •ë³´ ì„¹ì…˜ -->
    <div id="resultInfo" class="mt-4"></div>

    <!-- ê²°ê³¼ í…Œì´ë¸” ì„¹ì…˜ -->
    <div id="tableContainer" class="table-container"></div>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <button id="downloadBtn" class="btn btn-success" style="display:none;">ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const statusDiv = document.getElementById('status');
    const columnsDiv = document.getElementById('columnsList');
    const filterBtn = document.getElementById('filterBtn');
    const resultInfo = document.getElementById('resultInfo');
    const tableContainer = document.getElementById('tableContainer');
    const downloadBtn = document.getElementById('downloadBtn');

    let csvData = [];      // ì›ë³¸ ë°ì´í„° (ë°°ì—´ of ê°ì²´)
    let headers = [];      // ì»¬ëŸ¼ ì´ë¦„ ë¦¬ìŠ¤íŠ¸
    let filteredData = []; // í•„í„° ê²°ê³¼

    fileInput.addEventListener('change', handleFile, false);
    filterBtn.addEventListener('click', applyFilter, false);
    downloadBtn.addEventListener('click', downloadResult, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      statusDiv.textContent = 'ğŸ“‚ CSV ì½ëŠ” ì¤‘...';
      resultInfo.textContent = '';
      tableContainer.innerHTML = '';
      downloadBtn.style.display = 'none';
      filterBtn.style.display = 'none';

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          csvData = results.data;
          headers = results.meta.fields;

          statusDiv.textContent = 'âœ… CSV ì½ê¸° ì™„ë£Œ';
          columnsDiv.textContent = 'ì»¬ëŸ¼ ì´ë¦„ë“¤:\n' + headers.join(', ');

          if (!csvData.length) {
            resultInfo.textContent = 'âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
          }

          filterBtn.style.display = 'inline-block';
        },
        error: function(err) {
          statusDiv.textContent = 'âŒ CSV íŒŒì‹± ì˜¤ë¥˜: ' + err.message;
        }
      });
    }

    // í•µì‹¬ í•„í„°: Mismatches 0/1/2 = 1/0/0 & Direction='-'
    function applyFilter() {
      // ì»¬ëŸ¼ ì´ë¦„ ê³ ì • (CSV í—¤ë”ì— ì •í™•íˆ ì´ë ‡ê²Œ ìˆì–´ì•¼ í•¨)
      const colM0 = 'Mismatches 0';
      const colM1 = 'Mismatches 1';
      const colM2 = 'Mismatches 2';

      // Direction ì»¬ëŸ¼ ì´ë¦„ì€ 'Direction[?]' ë˜ëŠ” 'Direction' ë‘˜ ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆê²Œ ì²˜ë¦¬
      let colDir = null;
      if (headers.includes('Direction[?]')) {
        colDir = 'Direction[?]';
      } else if (headers.includes('Direction')) {
        colDir = 'Direction';
      }

      const missing = [];
      if (!headers.includes(colM0)) missing.push(colM0);
      if (!headers.includes(colM1)) missing.push(colM1);
      if (!headers.includes(colM2)) missing.push(colM2);
      if (!colDir) missing.push('Direction[?] / Direction');

      if (missing.length > 0) {
        alert('ë‹¤ìŒ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:\n' + missing.join(', ') +
              '\nCSV í—¤ë” ì´ë¦„ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // 1ì°¨ + 2ì°¨ ì¡°ê±´ í•œ ë²ˆì—
      filteredData = csvData.filter(row =>
        Number(row[colM0]) === 1 &&
        Number(row[colM1]) === 0 &&
        Number(row[colM2]) === 0 &&
        String(row[colDir] ?? '').trim() === '-'
      );

      resultInfo.textContent =
        `âœ… í•„í„° ê²°ê³¼ í–‰ ìˆ˜: ${filteredData.length} (ì¡°ê±´: M0=1, M1=0, M2=0, Direction='-')`;

      renderTable(filteredData);
      if (filteredData.length > 0) {
        downloadBtn.style.display = 'inline-block';
      } else {
        downloadBtn.style.display = 'none';
      }
    }

    // ê²°ê³¼ í‘œ ë Œë”ë§
    function renderTable(data) {
      if (!data || data.length === 0) {
        tableContainer.innerHTML = '<p>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const table = document.createElement('table');
      table.classList.add('table', 'table-striped');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const cols = Object.keys(data[0]);

      const trHead = document.createElement('tr');
      cols.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      data.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(h => {
          const td = document.createElement('td');
          const value = row[h];
          td.textContent = value == null ? '' : value;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tableContainer.innerHTML = '';
      tableContainer.appendChild(table);
    }

    // í•„í„° ê²°ê³¼ë¥¼ ì—‘ì…€(xlsx)ë¡œ ë‹¤ìš´ë¡œë“œ
    function downloadResult() {
      if (!filteredData || filteredData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Filtered');

      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filtered_mismatches_1_0_0.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
